{% extends 'base.html' %}
{% block title %}Milk Collections{% endblock %}
{% block content %}

<h2 class="text-3xl font-bold mb-6 text-gray-800">Milk Collections</h2>

<!-- Filter Section -->
<form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-8">
    <div>
        <label class="block text-sm font-medium mb-1">Start Date</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="w-40 border rounded px-3 py-2 shadow-sm">
    </div>
    <div>
        <label class="block text-sm font-medium mb-1">End Date</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="w-40 border rounded px-3 py-2 shadow-sm">
    </div>

    {% if user.role == "Admin" %}
    <div>
        <label class="block text-sm font-medium mb-1">Select Dairy</label>
        <select name="dairy_id" class="w-48 border rounded px-3 py-2 shadow-sm">
            <option value="">All Dairies</option>
            {% for dairy in dairies %}
                <option value="{{ dairy.id }}" {% if dairy.id|stringformat:"s" == selected_dairy_id %}selected{% endif %}>
                    {{ dairy.name }}
                </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    {% if user.role == "Manager" %}
        <div>
            <label class="block text-sm font-medium mb-1">Select Customer</label>
            <select name="customer_id" class="w-48 border rounded px-3 py-2 shadow-sm">
                <option value="">All Customer</option>
                {% for customer in customer %}
                    <option value="{{ customer.id }}" {% if customer.id|stringformat:"s" == customer_id %}selected{% endif %}>
                        {{ customer.user.first_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <div>
        <label class="block text-sm font-medium mb-1 ml-6">Payment Status</label>
        <select name="payment_status" class="w-36 ml-6 border rounded px-3 py-2 shadow-sm">
            <option value="">All</option>
            <option value="Paid" {% if payment_status == "Paid" %}selected{% endif %}>Paid</option>
            <option value="Unpaid" {% if payment_status == "Unpaid" %}selected{% endif %}>Unpaid</option>
        </select>
    </div>



    <div class="flex items-end">
        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
            Filter
        </button>
    </div>
</form>


<!-- Amount Summary by Type -->
{% if amount_summary %}
<div class="bg-white border rounded p-6 shadow mb-6">
    {% if totals %}
            <h3 class="text-lg font-semibold mb-2">Milk Summary</h3>
            <ul class="text-sm space-y-1">
                {% for item in totals %}
                <li>
                    <strong>{{ item.milk_type }}</strong> - 
                    <span class="text-blue-800">Total: {{ item.total|default:0 }}L</span>,
                    <span class="text-green-700">Purchase: {{ item.total_purchase|default:0 }}L</span>,
                    <span class="text-red-700">Sale: {{ item.total_sale|default:0 }}L</span>
                </li>
                {% endfor %}
            </ul>
    {% endif %}

    <h3 class="text-lg font-bold mb-4">Amount Summary</h3>
    
    <div class="flex flex-col md:flex-row justify-between gap-6 text-sm">
        <!-- Purchase Summary -->
        <div class="flex-1 bg-green-50 border border-green-300 rounded p-4">
            <h4 class="text-green-700 font-semibold mb-2">Purchase</h4>
            <ul class="space-y-1 text-green-900">
                <li>Total: â‚¹{{ amount_summary.purchase_total|floatformat:2 }}</li>
                <li>Paid: â‚¹{{ amount_summary.purchase_paid|floatformat:2 }}</li>
                <li>Unpaid: â‚¹{{ amount_summary.purchase_unpaid|floatformat:2 }}</li>
            </ul>
        </div>

        <!-- Sale Summary -->
        <div class="flex-1 bg-red-50 border border-red-300 rounded p-4">
            <h4 class="text-red-700 font-semibold mb-2">Sale</h4>
            <ul class="space-y-1 text-red-900">
                <li>Total: â‚¹{{ amount_summary.sale_total|floatformat:2 }}</li>
                <li>Paid: â‚¹{{ amount_summary.sale_paid|floatformat:2 }}</li>
                <li>Unpaid: â‚¹{{ amount_summary.sale_unpaid|floatformat:2 }}</li>
            </ul>
        </div>
    </div>
</div>

{% endif %}

{% if request.user.role in 'AdminManager' %}
    <div class="flex justify-end mb-4 space-x-2">
        <div>
            <a href="{% url 'milk_collection' %}" class="w-32 text-center inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
                âž• Collect
            </a>
            <a href="{% url 'milk_sale' %}" class="w-32 text-center inline-block bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm ml-2">
                ðŸ›’ Sell
            </a>
        </div>
{% endif %}

<form method="post" action="{% url 'update_payment_status' %}">
    {% csrf_token %}
    {% if request.user.role in 'AdminManager' %}

        <button type="submit" name="action" value="mark_paid"
            class="w-32 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            Mark Paid
        </button>
        <button type="submit" name="action" value="mark_unpaid"
            class="w-32 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
            Mark Unpaid
        </button>
    {% endif %}

    </div>

<!-- Milk Collection Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full border rounded-lg text-sm shadow-sm">
            <thead class="bg-blue-700 text-white">
                <tr>
                    <th class="py-3 px-4 text-left">Dairy</th>
                    <th class="py-3 px-4 text-left">Date</th>
                    <th class="py-3 px-4 text-left">Customer</th>
                    <th class="py-3 px-4 text-left">Type</th>
                    <th class="py-3 px-4 text-left">Quantity (L)</th>
                    <th class="py-3 px-4 text-left">Amount (â‚¹)</th>
                    <th class="py-3 px-4 text-left">Status</th>
                    {% if request.user.role in 'AdminManager' %}

                    <th class="py-3 px-4 text-center">Actions</th>
                    <th class="py-3 px-4 text-center">
                        <input type="checkbox" id="select_all" class="form-checkbox">
                    </th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white">
                {% for collection in collections %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">{{ collection.dairy.name }}</td>
                    <td class="py-3 px-4">{{ collection.collection_date }}</td>
                    <td class="py-3 px-4">{{ collection.userprofile.user.username }}</td>
                    <td class="py-3 px-4">{{ collection.milk_type }} ({{ collection.type }})</td>
                    <td class="py-3 px-4">{{ collection.quantity }}</td>
                    <td class="py-3 px-4">{{ collection.amount }}</td>
                    <td class="py-3 px-4">
                            {% if collection.is_paid %}
                                <span class="text-green-600 font-semibold">Paid</span>
                            {% else %}
                                <span class="text-red-600 font-semibold">Unpaid</span>
                            {% endif %}
                    </td>
                    {% if request.user.role in 'AdminManager' %}
                    
                        <td class="py-3 px-4 text-center space-x-1">
                            <a href="{% url 'edit_milk_collection' collection.id %}" class="text-blue-600 hover:underline">Edit</a> |
                            <a href="{% url 'delete_milk_collection' collection.id %}" class="text-red-600 hover:underline" onclick="return confirm('Are you sure?')">Delete</a>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <input type="checkbox" name="collection_ids" value="{{ collection.id }}" class="form-checkbox">
                        </td>
                {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center py-4 text-gray-500">No collections found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

<script>
    document.getElementById('select_all').addEventListener('click', function () {
        let checkboxes = document.querySelectorAll('input[name="collection_ids"]');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
</script>

{% endblock %}
